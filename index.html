<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Saree Inventory</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">üßµ Saree Inventory</div>
    <div class="actions">
      <button id="btn-export" class="btn ghost">Export CSV</button>
      <button id="btn-clear" class="btn ghost">Clear Filters</button>
      <button id="btn-cart" class="btn pill">Cart ‚Ä¢ <span id="cart-count">0</span></button>
    </div>
  </header>

  <section id="status" class="status">
    <div class="stat-card">
      <div class="stat-title">Total items</div>
      <div id="stat-total-items" class="stat-value">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">Items sold</div>
      <div id="stat-sold-items" class="stat-value">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">Total invested (cost)</div>
      <div id="stat-total-invested" class="stat-value">‚Çπ0</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">Invested on sold items</div>
      <div id="stat-invested-sold" class="stat-value">‚Çπ0</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">Total sold (sell price)</div>
      <div id="stat-total-sold" class="stat-value">‚Çπ0</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">Total profit</div>
      <div id="stat-profit" class="stat-value">‚Çπ0</div>
    </div>
  </section>

  <section class="controls">
    <input id="q" type="search" placeholder="Search by Saree Number, Color, Fabric" />
    <input id="minPrice" type="number" min="0" placeholder="Min ‚Çπ" />
    <input id="maxPrice" type="number" min="0" placeholder="Max ‚Çπ" />
    <select id="fabric"><option value="">Fabric</option></select>
    <select id="color"><option value="">Color</option></select>
    <select id="sort">
      <option value="relevance">Sort: Relevance</option>
      <option value="price-asc">Price: Low ‚Üí High</option>
      <option value="price-desc">Price: High ‚Üí Low</option>
      <option value="number-asc">Number: A ‚Üí Z</option>
      <option value="number-desc">Number: Z ‚Üí A</option>
    </select>
    <select id="soldFilter" class="sold-filter">
      <option value="all">All</option>
      <option value="available">Available</option>
      <option value="sold">Sold</option>
    </select>
    <label class="hide-sold"><input id="hideSold" type="checkbox" /> Hide sold</label>
  </section>

  <main id="grid" class="grid"></main>

  <!-- Item details modal -->
  <div id="item-modal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" id="modal-backdrop"></div>
    <div class="modal-content" role="dialog" aria-modal="true">
      <button id="modal-close" class="icon-btn" aria-label="Close">‚úï</button>
      <button id="modal-prev" class="icon-btn modal-arrow" aria-label="Previous">‚óÄ</button>
      <button id="modal-next" class="icon-btn modal-arrow" aria-label="Next">‚ñ∂</button>
      <div class="modal-body">
        <div class="modal-image-wrap"><img id="modal-image" src="" alt="Item image"/></div>
        <div class="modal-info">
          <h3 id="modal-title">-</h3>
          <div id="modal-meta" class="meta"></div>
          <div id="modal-price" class="price"></div>
          <div id="modal-sell" class="sold-price"></div>
        </div>
      </div>
    </div>
  </div>

  <aside id="cart-drawer" class="drawer">
    <div class="drawer-head">
      <h3>Cart</h3>
      <button id="close-cart" class="icon-btn" aria-label="Close">‚úï</button>
    </div>
    <div id="cart-items" class="cart-items"></div>
    <div class="drawer-foot">
      <div class="total">Total: ‚Çπ<span id="cart-total">0</span></div>
      <button id="checkout" class="btn">Checkout</button>
    </div>
  </aside>
  <div id="backdrop" class="backdrop"></div>

  <div id="toast" class="toast"></div>

  <script src="config.js"></script>
  <script src="script.js"></script>
</body>
</html>

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #667eea;
        }

        .error {
            background-color: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filters input,
        .filters select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
            flex: 1;
            min-width: 150px;
        }

        .filters button {
            padding: 10px 20px;
            background-color: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background-color 0.3s;
        }

        .filters button:hover {
            background-color: #764ba2;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        thead {
            background-color: #667eea;
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #ddd;
        }

        td {
            padding: 12px 15px;
            border: 1px solid #eee;
        }

        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tbody tr:hover {
            background-color: #f0f0f0;
            transition: background-color 0.2s;
        }

        .photo-cell {
            max-width: 100px;
            max-height: 100px;
            overflow: hidden;
            border-radius: 5px;
        }

        .photo-cell img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .photo-cell img:hover {
            transform: scale(1.05);
        }

        .photo-cell a {
            display: inline-block;
            width: 100%;
            height: 100%;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-sold {
            background-color: #d4edda;
            color: #155724;
        }

        .status-available {
            background-color: #cfe2ff;
            color: #084298;
        }

        .status-other {
            background-color: #e7e7e7;
            color: #333;
        }

        .price-cell {
            font-weight: 600;
            color: #667eea;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-card p {
            font-size: 2em;
            font-weight: bold;
        }

        .search-box {
            position: relative;
        }

        .search-box input::placeholder {
            color: #999;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            table {
                font-size: 0.85em;
            }

            th, td {
                padding: 8px 10px;
            }

            .filters {
                flex-direction: column;
            }

            .filters input,
            .filters select,
            .filters button {
                width: 100%;
                min-width: unset;
            }
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }

        .export-btn {
            background-color: #28a745;
            margin-left: 10px;
        }

        .export-btn:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßµ Saree Inventory</h1>
            <p>Complete inventory management system</p>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>Total Sarees</h3>
                <p id="total-sarees">0</p>
            </div>
            <div class="stat-card">
                <h3>Available</h3>
                <p id="available-sarees">0</p>
            </div>
            <div class="stat-card">
                <h3>Sold</h3>
                <p id="sold-sarees">0</p>
            </div>
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <p id="total-revenue">‚Çπ0</p>
            </div>
        </div>

        <div class="filters">
            <input type="text" id="search" class="search-box" placeholder="Search by color, fabric, number...">
            <select id="status-filter">
                <option value="">All Status</option>
                <option value="Sold">Sold</option>
                <option value="Available">Available</option>
            </select>
            <select id="fabric-filter">
                <option value="">All Fabrics</option>
            </select>
            <button onclick="applyFilters()">üîç Filter</button>
            <button class="export-btn" onclick="exportToCSV()">üì• Export CSV</button>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading">üìä Loading saree inventory...</div>

        <div class="table-wrapper" id="table-wrapper" style="display: none;">
            <table id="inventory-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Photo</th>
                        <th>Number</th>
                        <th>Color</th>
                        <th>Fabric</th>
                        <th>Status</th>
                        <th>Sell Price</th>
                        <th>Sold Price</th>
                    </tr>
                </thead>
                <tbody id="inventory-body">
                </tbody>
            </table>
        </div>

        <div id="no-results" class="no-results" style="display: none;">
            No sarees found matching your criteria.
        </div>
    </div>

    <script>
        // Use config from config.js
        const API_KEY = CONFIG.API_KEY;
        const SHEET_ID = CONFIG.SHEET_ID;
        const SHEET_NAME = CONFIG.SHEET_NAME;
        
        let allData = [];
        let filteredData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            fetchSareeData();
        });

        async function fetchSareeData() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length === 0) {
                    showError('No data found in the spreadsheet.');
                    return;
                }

                // Parse the data
                parseData(data.values);
                displayData(allData);
                populateFilters();
                calculateStats();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('table-wrapper').style.display = 'block';
            } catch (error) {
                showError('Error fetching data: ' + error.message);
                console.error('Error:', error);
            }
        }

        function parseData(values) {
            // Skip header row and parse data
            const headers = values[0];
            
            for (let i = 1; i < values.length; i++) {
                const row = values[i];
                if (row.length === 0) continue; // Skip empty rows
                
                const saree = {
                    timestamp: row[0] || '',
                    photo: row[1] || '',
                    number: row[2] || '',
                    color: row[3] || '',
                    fabric: row[4] || '',
                    status: row[5] || 'Available',
                    sellPrice: parseFloat(row[6]) || 0,
                    soldPrice: parseFloat(row[7]) || 0
                };
                
                allData.push(saree);
            }
            
            filteredData = [...allData];
        }

        function displayData(data) {
            const tbody = document.getElementById('inventory-body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                document.getElementById('table-wrapper').style.display = 'none';
                document.getElementById('no-results').style.display = 'block';
                return;
            }

            document.getElementById('no-results').style.display = 'none';
            document.getElementById('table-wrapper').style.display = 'block';

            data.forEach(saree => {
                const row = document.createElement('tr');
                
                const statusClass = saree.status === 'Sold' ? 'status-sold' : 'status-available';
                
                let photoCell = '‚Äî';
                if (saree.photo && saree.photo.trim()) {
                    let imageUrl = saree.photo.trim();
                    
                    // Convert Google Drive link to direct image URL
                    if (imageUrl.includes('drive.google.com')) {
                        // Extract file ID from various Google Drive URL formats
                        let fileId = null;
                        const matches = [
                            imageUrl.match(/\/d\/([a-zA-Z0-9-_]+)/),
                            imageUrl.match(/id=([a-zA-Z0-9-_]+)/),
                            imageUrl.match(/open\?id=([a-zA-Z0-9-_]+)/)
                        ];
                        
                        for (let match of matches) {
                            if (match && match[1]) {
                                fileId = match[1];
                                break;
                            }
                        }
                        
                        if (fileId) {
                            // Use multiple URL formats to try to get the image
                            imageUrl = `https://lh3.google.com/d/${fileId}=w200`;
                        }
                    }
                    
                    photoCell = `<a href="${saree.photo}" target="_blank"><img src="${imageUrl}" alt="Saree" class="thumbnail-img" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2214%22 fill=%22%23999%22%3ENo Image%3C/text%3E%3C/svg%3E'"></a>`;
                }

                row.innerHTML = `
                    <td>${formatDate(saree.timestamp)}</td>
                    <td class="photo-cell">${photoCell}</td>
                    <td><strong>${saree.number}</strong></td>
                    <td>${saree.color}</td>
                    <td>${saree.fabric}</td>
                    <td><span class="status-badge ${statusClass}">${saree.status}</span></td>
                    <td class="price-cell">‚Çπ${saree.sellPrice.toLocaleString()}</td>
                    <td class="price-cell">‚Çπ${saree.soldPrice.toLocaleString()}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-IN', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            } catch (e) {
                return dateString;
            }
        }

        function populateFilters() {
            const fabrics = [...new Set(allData.map(s => s.fabric).filter(Boolean))];
            const fabricSelect = document.getElementById('fabric-filter');
            
            fabrics.forEach(fabric => {
                const option = document.createElement('option');
                option.value = fabric;
                option.textContent = fabric;
                fabricSelect.appendChild(option);
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const fabricFilter = document.getElementById('fabric-filter').value;

            filteredData = allData.filter(saree => {
                const matchSearch = !searchTerm || 
                    saree.color.toLowerCase().includes(searchTerm) ||
                    saree.fabric.toLowerCase().includes(searchTerm) ||
                    saree.number.toLowerCase().includes(searchTerm);
                
                const matchStatus = !statusFilter || saree.status === statusFilter;
                const matchFabric = !fabricFilter || saree.fabric === fabricFilter;

                return matchSearch && matchStatus && matchFabric;
            });

            displayData(filteredData);
            calculateStats(filteredData);
        }

        function calculateStats(data = allData) {
            const total = data.length;
            const sold = data.filter(s => s.status === 'Sold').length;
            const available = total - sold;
            const revenue = data.filter(s => s.status === 'Sold').reduce((sum, s) => sum + s.soldPrice, 0);

            document.getElementById('total-sarees').textContent = total;
            document.getElementById('available-sarees').textContent = available;
            document.getElementById('sold-sarees').textContent = sold;
            document.getElementById('total-revenue').textContent = '‚Çπ' + revenue.toLocaleString();
        }

        function exportToCSV() {
            const rows = [['Timestamp', 'Number', 'Color', 'Fabric', 'Status', 'Sell Price', 'Sold Price']];
            
            filteredData.forEach(saree => {
                rows.push([
                    saree.timestamp,
                    saree.number,
                    saree.color,
                    saree.fabric,
                    saree.status,
                    saree.sellPrice,
                    saree.soldPrice
                ]);
            });

            const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `saree-inventory-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Real-time search
        document.getElementById('search').addEventListener('keyup', applyFilters);
        document.getElementById('status-filter').addEventListener('change', applyFilters);
        document.getElementById('fabric-filter').addEventListener('change', applyFilters);
    </script>
</body>
</html>
